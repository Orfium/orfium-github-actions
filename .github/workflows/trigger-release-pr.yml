name: 'Trigger Release to Production PR'
on:
  workflow_call:
    inputs:
      baseBranchName:
        description: 'Production branch name (default: `main`)'
        required: false
        default: 'main'
        type: string
      headBranchName:
        description: 'Staging/Development branch name (default: `develop`)'
        required: false
        default: 'develop'
        type: string
      releasePrTitle:
        description: 'The title of the pull request. (default: `Release to Production {{ today.date }}`)'
        required: false
        default: ''
        type: string
      releasePrBody:
        description: 'The body of the pull request. (default: `This PR is auto-generated by [orfium-github-actions/trigger-release-pr.yml](https://github.com/Orfium/orfium-github-actions/blob/master/.github/workflows/trigger-release-pr.yml).`)'
        required: false
        default: 'This PR is auto-generated by\n [orfium-github-actions/trigger-release-pr.yml](https://github.com/Orfium/orfium-github-actions/blob/master/.github/workflows/trigger-release-pr.yml).'
        type: string
      releasePrLabels:
        description: 'A comma separated list of labels. (default: `release,automated pr`)'
        required: false
        default: 'release,automated pr'
        type: string
      releasePrIsDraft:
        description: 'Create a draft pull request. (default: `false`)'
        required: false
        default: false
        type: boolean
      releasePrReviewers:
        description: 'A comma or newline separated list of reviewers (GitHub usernames) to request a review from. (default: ``)'
        required: false
        default: ''
        type: string
      releasePrTeamReviewers:
        description: >
          A comma or newline separated list of GitHub teams to request a review from.
          Note that a `repo` scoped Personal Access Token (PAT) may be required. (default: ``)
        required: false
        default: ''
        type: string
    secrets:
      token:
        required: true

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: Get current date
        id: date
        run: echo "date=$(date +'%d/%m/%Y')" >> "$GITHUB_OUTPUT"
      - name: Create release pull request
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.token }}
          script: |
            let title = '${{ inputs.releasePrTitle }}';
            if (title === '') {
              title = 'Release to Production ${{ steps.date.outputs.date }}';
            }
            
            // Create pull request
            const result = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: '${{ inputs.headBranchName }}',
              base: '${{ inputs.baseBranchName }}',
              title: title,
              body: '${{ inputs.releasePrBody }}',
              draft: ${{ inputs.releasePrIsDraft }}
            });
            
            // Add labels on automated pr
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: result.data.number,
              labels: '${{ inputs.releasePrLabels }}'.split(',')
            });
            
            // Request reviewers on automated pr
            github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: result.data.number,
              reviewers: '${{ inputs.releasePrReviewers }}'.split(','),
              team_reviewers: '${{ inputs.releasePrTeamReviewers }}'.split(',')
            });
